;(function(n,t){var s=function(){function t(t,e){this.settings=n.extend(true,n.fn.headIndex.default,e||{});this.element=t;this.init()}t.prototype={init:function(){this.articleWrap=n(this.settings.articleWrapSelector);this.headerList=this.articleWrap.find(":header");this.indexBox=n(this.settings.indexBoxSelector);this.scrollBody=n(this.settings.scrollSelector);this.scrollWrap=n(this.settings.scrollWrap);this.manual=false;if(this.indexBox.length===0||this.articleWrap.length===0){return null}this.initHeader();this.event()},initHeader:function(){for(var t=0;t<this.headerList.length;t++,this.autoId++){this.headerList[t].id=this.headerList[t].id||"header-id-"+this.autoId;this.headerList[t].topHeight=this.offsetTop(this.headerList[t]);this.headerList[t].h=Number(this.headerList[t].tagName.charAt(1))}this.tempHtml=[];this.buildHtml(this.buildTree());var e="<ul>"+this.tempHtml.join("")+"</ul>";this.indexBox.html(e)},event:function(){var s=this;var h=null;this.indexBox.on("click.headindex",function(t){var e=n(t.target);if(e.hasClass(s.settings.linkClass)){t.preventDefault();var i=e.parent("."+s.settings.itemClass);s.manual=true;if(h){clearTimeout(h);h=null}h=setTimeout(function(){s.manual=false},300);s.current(i);s.scrollTo(t.target.getAttribute("href"))}});n(this.scrollWrap).scroll(function(){if(s.manual)return;s.updateCurrent()});s.updateCurrent()},updateTopHeight:function(){var t=this.headerList.length;var e;if(t===0)return;if(this.headerList[0].topHeight===this.offsetTop(this.headerList[0])&&this.headerList[t-1].topHeight===this.offsetTop(this.headerList[t-1])){return}if(this.headerList[0].topHeight-this.offsetTop(this.headerList[0])===this.headerList[t-1].topHeight-this.offsetTop(this.headerList[t-1])){var i=this.offsetTop(this.headerList[0])-this.headerList[0].topHeight;for(e=0;e<this.headerList.length;e++,this.autoId++){this.headerList[e].topHeight+=i}return}for(e=0;e<this.headerList.length;e++,this.autoId++){this.headerList[e].topHeight=this.offsetTop(this.headerList[e])}},current:function(t){var e,i="current";if(t.length===0||t.hasClass(i)){return}var s=this.indexBox.find("li."+i);if(s.length>0){s.removeClass(i)}this.indexBox.find("ul.open").removeClass("open");e=t.children("."+this.settings.subItemBoxClass);if(e.length>0){e.addClass("open").slideDown()}var h=t.parents("ul."+this.settings.subItemBoxClass);if(h.length>0){h.addClass("open").slideDown()}e=this.indexBox.find("ul."+this.settings.subItemBoxClass).not(".open");if(e.length>0){e.slideUp()}t.addClass(i)},buildHtml:function(t){if(t===undefined)return;if(t.length===0){this.tempHtml.push("<p style='margin:10px'>然而并没有目录QAQ</p>");return;}for(var e=0;e<t.length;e++){this.tempHtml.push("<li class='"+this.settings.itemClass+"'>"+"<a class='"+this.settings.linkClass+"' href='#"+t[e].item.id+"'>"+t[e].item.innerText+"</a>");if(t[e].children.length!==0){this.tempHtml.push("<ul class='"+this.settings.subItemBoxClass+"'>");this.buildHtml(t[e].children);this.tempHtml.push("</ul>")}this.tempHtml.push("</li>")}},buildTree:function(){var t=null,e,i=[];for(var s=0;s<this.headerList.length;s++){if(t==null){t={item:this.headerList[s],parent:null,children:[]};i.push(t);continue}if(t.item.h<this.headerList[s].h){e={item:this.headerList[s],parent:t,children:[]};t.children.push(e);t=e;continue}if(t.item.h===this.headerList[s].h){e={item:this.headerList[s],parent:t.parent,children:[]};(t.parent&&t.parent.children||i).push(e);t=e;continue}while(t!=null&&t.item.h>this.headerList[s].h){t=t.parent}if(t==null){t={item:this.headerList[s],parent:null,children:[]};i.push(t);continue}s--}return i},search:function(t,e,i){if(this.headerList.length===0)return null;if(e-t<=1){if(this.headerList[e].topHeight<i){return this.headerList[e]}return this.headerList[t]}if(t<e){var s=parseInt((t+e)/2);var h=this.headerList[s].topHeight;if(i<h){e=s}else if(i>h){t=s}else{return this.headerList[s]}return this.search(t,e,i)}},offsetTop:function(t){var e=this.articleWrap[0].getBoundingClientRect().top;var i=t.getBoundingClientRect().top;return parseInt(i-e-this.settings.offset)},scrollTo:function(t){this.scrollBody.stop().animate({scrollTop:this.offsetTop(document.querySelector(t))},"fast")},updateCurrent:function(){var t=this.scrollBody.scrollTop();this.updateTopHeight();var e=this.search(0,this.headerList.length-1,t);if(!e){return}var i=this.indexBox.find('a[href="#'+e.id+'"]').parent("li."+this.settings.itemClass);this.current(i)},clean:function(){if(this.element){this.element.data("headIndex",null)}},ignoreScrollEvent:function(t){if(t){this.manual=true}else{this.manual=false;this.updateCurrent()}}};t.prototype.autoId=1;return t}();n.fn.headIndex=function(i){return this.each(function(){var t=n(this),e=t.data("headIndex");if(!e){e=new s(t,i);t.data("headIndex",e)}if(n.type(i)==="string")return e[i]()})};n.fn.headIndex.default={articleWrapSelector:".article-wrap",indexBoxSelector:".index-box",scrollSelector:"body,html",scrollWrap:t,subItemBoxClass:"index-subItem-box",itemClass:"index-item",linkClass:"index-link",offset:0}})(jQuery,window);